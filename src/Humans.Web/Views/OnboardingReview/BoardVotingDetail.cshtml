@model Humans.Web.Models.BoardVotingDetailViewModel
@{
    ViewData["Title"] = string.Format(Localizer["BoardVoting_DetailTitle"].Value, Model.DisplayName);
}

<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a asp-action="BoardVoting">@Localizer["BoardVoting_Title"]</a></li>
        <li class="breadcrumb-item active" aria-current="page">@Model.DisplayName</li>
    </ol>
</nav>

<vc:temp-data-alerts />

<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">@Localizer["OnboardingReview_ProfileSummary"]</div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-4">@Localizer["OnboardingReview_LegalName"]</dt>
                    <dd class="col-sm-8">@Model.FirstName @Model.LastName</dd>

                    <dt class="col-sm-4">@Localizer["Governance_Submitted"]</dt>
                    <dd class="col-sm-8">@Model.SubmittedAt.ToString("d MMMM yyyy")</dd>

                    <dt class="col-sm-4">@Localizer["AdminHuman_MembershipTier"]</dt>
                    <dd class="col-sm-8">
                        <span class="badge @(Model.MembershipTier == MembershipTier.Asociado ? "bg-primary" : "bg-info")">
                            @Model.MembershipTier
                        </span>
                    </dd>

                    @if (!string.IsNullOrEmpty(Model.ApplicationMotivation))
                    {
                        <dt class="col-sm-4">@Localizer["OnboardingReview_ApplicationMotivation"]</dt>
                        <dd class="col-sm-8" style="white-space: pre-wrap;">@Model.ApplicationMotivation</dd>
                    }
                </dl>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(Model.AdditionalInfo))
        {
            <div class="card mb-4">
                <div class="card-header">@Localizer["BoardVoting_AdditionalInfo"]</div>
                <div class="card-body">
                    <p class="mb-0" style="white-space: pre-wrap;">@Model.AdditionalInfo</p>
                </div>
            </div>
        }

        @if (!string.IsNullOrEmpty(Model.SignificantContribution))
        {
            <div class="card mb-4">
                <div class="card-header">@Localizer["Application_SignificantContribution"]</div>
                <div class="card-body">
                    <p class="mb-0" style="white-space: pre-wrap;">@Model.SignificantContribution</p>
                </div>
            </div>
        }

        @if (!string.IsNullOrEmpty(Model.RoleUnderstanding))
        {
            <div class="card mb-4">
                <div class="card-header">@Localizer["Application_RoleUnderstanding"]</div>
                <div class="card-body">
                    <p class="mb-0" style="white-space: pre-wrap;">@Model.RoleUnderstanding</p>
                </div>
            </div>
        }

        @if (Model.Votes.Count > 0)
        {
            <div class="card mb-4">
                <div class="card-header">@Localizer["BoardVoting_VotesSoFar"]</div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>@Localizer["BoardVoting_BoardMember"]</th>
                                <th>@Localizer["BoardVoting_Vote"]</th>
                                <th>@Localizer["BoardVoting_Date"]</th>
                                <th>@Localizer["BoardVoting_Note"]</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var v in Model.Votes)
                            {
                                var badgeClass = v.Vote switch
                                {
                                    VoteChoice.Yay => "bg-success",
                                    VoteChoice.Maybe => "bg-warning text-dark",
                                    VoteChoice.No => "bg-danger",
                                    VoteChoice.Abstain => "bg-secondary",
                                    _ => "bg-secondary"
                                };
                                <tr>
                                    <td>@v.DisplayName</td>
                                    <td><span class="badge @badgeClass">@v.Vote</span></td>
                                    <td><small>@v.VotedAt.ToString("d MMM yyyy")</small></td>
                                    <td><small class="text-muted">@v.Note</small></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }

        <vc:profile-card user-id="@Model.UserId" view-mode="@Humans.Web.ViewComponents.ProfileCardViewMode.Admin" />
    </div>

    <div class="col-md-4">
        @if (User.IsInRole("Board"))
        {
            <div class="card mb-4">
                <div class="card-header">@Localizer["BoardVoting_CastVote"]</div>
                <div class="card-body">
                    <form asp-action="Vote" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="applicationId" value="@Model.ApplicationId" />

                        <div class="mb-3">
                            <label class="form-label">@Localizer["BoardVoting_YourVote"]</label>
                            <div class="d-grid gap-2">
                                @foreach (var choice in Enum.GetValues<VoteChoice>())
                                {
                                    var btnClass = choice switch
                                    {
                                        VoteChoice.Yay => "btn-outline-success",
                                        VoteChoice.Maybe => "btn-outline-warning",
                                        VoteChoice.No => "btn-outline-danger",
                                        VoteChoice.Abstain => "btn-outline-secondary",
                                        _ => "btn-outline-secondary"
                                    };
                                    var isActive = Model.CurrentUserVote == choice;
                                    <button type="submit" name="vote" value="@choice"
                                            class="btn @(isActive ? btnClass.Replace("outline-", "") : btnClass)">
                                        @choice
                                    </button>
                                }
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="voteNote" class="form-label">@Localizer["BoardVoting_Note"]</label>
                            <textarea id="voteNote" name="note" class="form-control" rows="2"
                                      placeholder="@Localizer["OnboardingReview_NotesPlaceholder"].Value">@Model.CurrentUserNote</textarea>
                        </div>
                    </form>
                </div>
            </div>
        }

        @if (Model.CanFinalize)
        {
            <div class="card mb-4">
                <div class="card-header">@Localizer["BoardVoting_FinalizeDecision"]</div>
                <div class="card-body">
                    <form asp-action="Finalize" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="ApplicationId" value="@Model.ApplicationId" />

                        <div class="mb-3">
                            <label for="boardMeetingDate" class="form-label">@Localizer["BoardVoting_MeetingDate"]</label>
                            <input type="date" id="boardMeetingDate" name="BoardMeetingDate" class="form-control" />
                        </div>

                        <div class="mb-3">
                            <label for="decisionNote" class="form-label">@Localizer["BoardVoting_DecisionNote"]</label>
                            <textarea id="decisionNote" name="DecisionNote" class="form-control" rows="3"
                                      placeholder="@Localizer["BoardVoting_DecisionNotePlaceholder"].Value"></textarea>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" name="Approved" value="true" class="btn btn-success"
                                    data-confirm="@Localizer["BoardVoting_ApproveConfirm"].Value">
                                <i class="fa-solid fa-check me-1"></i> @Localizer["BoardVoting_Approve"]
                            </button>
                            <button type="submit" name="Approved" value="false" class="btn btn-danger"
                                    data-confirm="@Localizer["BoardVoting_RejectConfirm"].Value">
                                <i class="fa-solid fa-xmark me-1"></i> @Localizer["BoardVoting_Reject"]
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        }
    </div>
</div>
