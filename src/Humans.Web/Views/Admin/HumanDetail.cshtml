@using Humans.Web.ViewComponents
@model Humans.Web.Models.AdminHumanDetailViewModel
@{
    ViewData["Title"] = string.Format(Localizer["AdminHumanDetail_Title"].Value, Model.DisplayName);
}

<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a asp-action="Index">@Localizer["Nav_Admin"]</a></li>
        <li class="breadcrumb-item"><a asp-action="Humans">@Localizer["AdminHumans_Title"]</a></li>
        <li class="breadcrumb-item active" aria-current="page">@Model.DisplayName</li>
    </ol>
</nav>

<vc:temp-data-alerts />

<div class="row">
    <div class="col-md-8">
        @* Admin-specific info card (user ID, joined, last login) *@
        <div class="card mb-4">
            <div class="card-header">@Localizer["AdminHuman_Information"]</div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-2">
                        <vc:user-avatar profile-picture-url="@Model.ProfilePictureUrl"
                                        display-name="@Model.DisplayName"
                                        size="80" />
                    </div>
                    <div class="col-md-10">
                        <h4>@Model.DisplayName</h4>
                        <p class="text-muted mb-1">@Model.Email</p>
                        @if (Model.IsSuspended)
                        {
                            <span class="badge bg-danger">@Localizer["AdminHuman_Suspended"]</span>
                        }
                        else if (Model.HasProfile && !Model.IsApproved)
                        {
                            <span class="badge bg-warning">@Localizer["AdminHuman_PendingApproval"]</span>
                        }
                        else if (Model.HasProfile && Model.IsApproved)
                        {
                            <span class="badge bg-success">@Localizer["AdminHuman_Approved"]</span>
                        }
                    </div>
                </div>

                @if (Model.IsRejected)
                {
                    <div class="alert alert-danger mt-3 mb-0">
                        <strong><i class="fa-solid fa-ban me-1"></i> Rejected</strong>
                        @if (!string.IsNullOrEmpty(Model.RejectionReason))
                        {
                            <p class="mb-1 mt-1" style="white-space: pre-wrap;">@Model.RejectionReason</p>
                        }
                        <small class="text-muted">
                            @if (Model.RejectedAt.HasValue)
                            {
                                @Model.RejectedAt.Value.ToString("d MMMM yyyy HH:mm")
                            }
                            @if (!string.IsNullOrEmpty(Model.RejectedByName))
                            {
                                <text> by @Model.RejectedByName</text>
                            }
                        </small>
                    </div>
                }

                <hr />

                <dl class="row mb-0">
                    <dt class="col-sm-3">@Localizer["AdminHuman_MembershipTier"]</dt>
                    <dd class="col-sm-9">@Model.MembershipTier</dd>

                    <dt class="col-sm-3">@Localizer["AdminHuman_ConsentCheck"]</dt>
                    <dd class="col-sm-9">
                        @if (Model.ConsentCheckStatus.HasValue)
                        {
                            var badgeClass = Model.ConsentCheckStatus.Value switch
                            {
                                Humans.Domain.Enums.ConsentCheckStatus.Cleared => "bg-success",
                                Humans.Domain.Enums.ConsentCheckStatus.Flagged => "bg-danger",
                                _ => "bg-warning"
                            };
                            <span class="badge @badgeClass">@Model.ConsentCheckStatus.Value</span>
                        }
                        else
                        {
                            <span class="text-muted">@Localizer["AdminHuman_NotStarted"]</span>
                        }
                    </dd>

                    <dt class="col-sm-3">@Localizer["AdminHuman_UserId"]</dt>
                    <dd class="col-sm-9"><code>@Model.UserId</code></dd>

                    <dt class="col-sm-3">@Localizer["Admin_Joined"]</dt>
                    <dd class="col-sm-9">@Model.CreatedAt.ToString("d MMMM yyyy HH:mm")</dd>

                    <dt class="col-sm-3">@Localizer["Admin_LastLogin"]</dt>
                    <dd class="col-sm-9">
                        @if (Model.LastLoginAt.HasValue)
                        {
                            @Model.LastLoginAt.Value.ToString("d MMMM yyyy HH:mm")
                        }
                        else
                        {
                            <span class="text-muted">@Localizer["Admin_Never"]</span>
                        }
                    </dd>
                </dl>
            </div>
        </div>

        @* Profile card (shared component) *@
        <vc:profile-card user-id="@Model.UserId" view-mode="@ProfileCardViewMode.Admin" />

        @if (!string.IsNullOrEmpty(Model.AdminNotes))
        {
            <div class="card mb-4">
                <div class="card-header">@Localizer["AdminHuman_AdminNotes"]</div>
                <div class="card-body">
                    <p class="mb-0" style="white-space: pre-wrap;">@Model.AdminNotes</p>
                    <small class="text-muted mt-2 d-block">@Localizer["AdminHuman_AdminNotesGdprHint"]</small>
                </div>
            </div>
        }

        @if (Model.Applications.Count > 0)
        {
            <div class="card mb-4">
                <div class="card-header">@Localizer["AdminHuman_RecentApplications"]</div>
                <div class="list-group list-group-flush">
                    @foreach (var app in Model.Applications)
                    {
                        <a asp-action="ApplicationDetail" asp-route-id="@app.Id" class="list-group-item list-group-item-action d-flex justify-content-between">
                            <span>@app.SubmittedAt.ToString("d MMM yyyy")</span>
                            <span class="badge bg-secondary">@app.Status</span>
                        </a>
                    }
                </div>
            </div>
        }

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>@Localizer["AdminHuman_RoleAssignments"]</span>
                <a asp-action="AddRole" asp-route-id="@Model.UserId" class="btn btn-sm btn-outline-primary">@Localizer["AdminHuman_AddRole"]</a>
            </div>
            @if (Model.RoleAssignments.Count > 0)
            {
                <div class="list-group list-group-flush">
                    @foreach (var role in Model.RoleAssignments)
                    {
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>@role.RoleName</strong>
                                @if (role.IsActive)
                                {
                                    <span class="badge bg-success ms-2">@Localizer["AdminHuman_Active"]</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary ms-2">@Localizer["AdminHuman_Ended"]</span>
                                }
                                <br />
                                <small class="text-muted">
                                    @Localizer["AdminHuman_From"] @role.ValidFrom.ToString("d MMM yyyy")
                                    @if (role.ValidTo.HasValue)
                                    {
                                        <text> @Localizer["AdminHuman_To"] @role.ValidTo.Value.ToString("d MMM yyyy")</text>
                                    }
                                    @if (!string.IsNullOrEmpty(role.Notes))
                                    {
                                        <text> &mdash; @role.Notes</text>
                                    }
                                </small>
                            </div>
                            @if (role.IsActive)
                            {
                                <form asp-action="EndRole" asp-route-id="@role.Id" method="post" class="d-inline"
                                      data-confirm="@Localizer["AdminHuman_EndRoleConfirm"].Value">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-sm btn-outline-danger">@Localizer["AdminHuman_End"]</button>
                                </form>
                            }
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="card-body text-muted">
                    @Localizer["AdminHuman_NoRoleAssignments"]
                </div>
            }
        </div>

        <div class="card mb-4">
            <div class="card-header">@Localizer["AdminHuman_AuditHistory"]</div>
            @if (Model.AuditLog.Count > 0)
            {
                <div class="list-group list-group-flush">
                    @foreach (var entry in Model.AuditLog)
                    {
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>@entry.Description</strong>
                                    <br />
                                    <small class="text-muted">
                                        @if (entry.IsSystemAction)
                                        {
                                            <span class="badge bg-info">System</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Admin</span>
                                        }
                                        @entry.ActorName
                                    </small>
                                </div>
                                <small class="text-muted text-nowrap ms-2">
                                    @entry.OccurredAt.ToString("d MMM yyyy HH:mm")
                                </small>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="card-body text-muted">
                    @Localizer["AdminHuman_NoAuditHistory"]
                </div>
            }
        </div>
    </div>

    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">@Localizer["AdminHuman_Statistics"]</div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-8">@Localizer["AdminHuman_ApplicationCount"]</dt>
                    <dd class="col-4 text-end">@Model.ApplicationCount</dd>
                    <dt class="col-8">@Localizer["AdminHuman_ConsentCount"]</dt>
                    <dd class="col-4 text-end">@Model.ConsentCount</dd>
                </dl>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">Google Sync</div>
            <div class="card-body">
                <a asp-action="HumanGoogleSyncAudit" asp-route-id="@Model.UserId"
                   class="btn btn-outline-secondary w-100">View Google Sync Audit</a>
            </div>
        </div>

        <div class="card">
            <div class="card-header">@Localizer["TeamDetail_Actions"]</div>
            <div class="card-body">
                @if (Model.HasProfile && !Model.IsApproved && !Model.IsSuspended)
                {
                    <form asp-action="ApproveVolunteer" asp-route-id="@Model.UserId" method="post">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-success w-100 mb-2">@Localizer["AdminHuman_ApproveVolunteer"]</button>
                    </form>
                    <hr />
                }
                @if (Model.IsSuspended)
                {
                    <form asp-action="UnsuspendHuman" asp-route-id="@Model.UserId" method="post">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-success w-100 mb-2">@Localizer["AdminHuman_UnsuspendMember"]</button>
                    </form>
                }
                else
                {
                    <form asp-action="SuspendHuman" asp-route-id="@Model.UserId" method="post"
                          data-confirm="@Localizer["AdminHuman_SuspendConfirm"].Value">
                        @Html.AntiForgeryToken()
                        <div class="mb-2">
                            <textarea name="notes" class="form-control" rows="2" placeholder="@Localizer["AdminHuman_SuspendReasonPlaceholder"].Value"></textarea>
                            <small class="form-text text-muted">@Localizer["AdminHuman_AdminNotesGdprHint"]</small>
                        </div>
                        <button type="submit" class="btn btn-danger w-100">@Localizer["AdminHuman_SuspendMember"]</button>
                    </form>
                }
                @if (Model.HasProfile && !Model.IsRejected)
                {
                    <hr />
                    <form asp-action="RejectSignup" asp-route-id="@Model.UserId" method="post"
                          data-confirm="Are you sure you want to reject this human's signup? This cannot be undone.">
                        @Html.AntiForgeryToken()
                        <div class="mb-2">
                            <textarea name="reason" class="form-control" rows="2" placeholder="Reason for rejection..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-outline-danger w-100">
                            <i class="fa-solid fa-ban me-1"></i> Reject Signup
                        </button>
                    </form>
                }
                <environment exclude="Production">
                    <hr />
                    <form asp-action="PurgeHuman" asp-route-id="@Model.UserId" method="post"
                          data-confirm="PURGE @Model.DisplayName? This severs their login â€” they will get a completely fresh account next time they sign in.">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-danger w-100">
                            <i class="fa-solid fa-skull-crossbones me-1"></i> Purge (Dev/QA Only)
                        </button>
                        <small class="form-text text-muted">Severs OAuth link and locks account. Next login creates a fresh user.</small>
                    </form>
                </environment>
            </div>
        </div>
    </div>
</div>
