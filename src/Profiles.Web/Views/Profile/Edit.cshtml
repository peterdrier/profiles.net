@model Profiles.Web.Models.ProfileViewModel
@{
    ViewData["Title"] = Localizer["ProfileEdit_Title"].Value;
}

<div class="row">
    <div class="col-12" style="max-width: 900px;">
        <h1>@Localizer["ProfileEdit_Title"]</h1>

        <div class="card">
            <div class="card-body">
                <form asp-action="Edit" method="post" enctype="multipart/form-data">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <h5>@Localizer["Profile_ProfilePicture"]</h5>
                    <div class="mb-3">
                        <div class="d-flex align-items-center gap-3 mb-2">
                            @if (Model.HasCustomProfilePicture && !string.IsNullOrEmpty(Model.CustomProfilePictureUrl))
                            {
                                <img src="@Model.CustomProfilePictureUrl" alt="Current profile picture" class="rounded-circle" style="width: 80px; height: 80px; object-fit: cover;" />
                            }
                            else if (!string.IsNullOrEmpty(Model.ProfilePictureUrl))
                            {
                                <img src="@Model.ProfilePictureUrl" alt="Google avatar" class="rounded-circle" style="width: 80px; height: 80px; object-fit: cover;" />
                                <span class="text-muted small">@Localizer["ProfileEdit_GoogleAvatar"]</span>
                            }
                            else
                            {
                                <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center text-white" style="width: 80px; height: 80px; font-size: 1.5rem;">
                                    @(string.IsNullOrEmpty(Model.BurnerName) ? "?" : Model.BurnerName[0])
                                </div>
                            }
                        </div>
                        <input type="file" asp-for="ProfilePictureUpload" class="form-control" accept="image/jpeg,image/png,image/webp" />
                        <span asp-validation-for="ProfilePictureUpload" class="text-danger"></span>
                        <div class="form-text">@Localizer["ProfileEdit_PictureHelp"]</div>
                        @if (Model.HasCustomProfilePicture)
                        {
                            <div class="form-check mt-2">
                                <input type="checkbox" asp-for="RemoveProfilePicture" class="form-check-input" />
                                <label asp-for="RemoveProfilePicture" class="form-check-label">@Localizer["ProfileEdit_RemovePicture"]</label>
                            </div>
                        }
                    </div>

                    <hr />

                    <div class="mb-3">
                        <label asp-for="BurnerName" class="form-label"></label>
                        <input asp-for="BurnerName" class="form-control" placeholder="@Localizer["ProfileEdit_BurnerNamePlaceholder"].Value" />
                        <span asp-validation-for="BurnerName" class="text-danger"></span>
                        <div class="form-text">@Localizer["ProfileEdit_BurnerNameHelp"]</div>
                    </div>

                    <hr />
                    <h5>@Localizer["Profile_LegalName"]</h5>
                    <p class="text-muted small mb-3">
                        @Localizer["ProfileEdit_LegalNameHelp"]
                    </p>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label asp-for="FirstName" class="form-label"></label>
                            <input asp-for="FirstName" class="form-control" />
                            <span asp-validation-for="FirstName" class="text-danger"></span>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="LastName" class="form-label"></label>
                            <input asp-for="LastName" class="form-control" />
                            <span asp-validation-for="LastName" class="text-danger"></span>
                        </div>
                    </div>

                    <hr />
                    <h5>@Localizer["Profile_Phone"]</h5>

                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label asp-for="PhoneCountryCode" class="form-label"></label>
                            <select asp-for="PhoneCountryCode" class="form-select">
                                <option value="">@Localizer["ProfileEdit_Select"]</option>
                                <option value="+34">+34 (Spain)</option>
                                <option value="+33">+33 (France)</option>
                                <option value="+49">+49 (Germany)</option>
                                <option value="+39">+39 (Italy)</option>
                                <option value="+351">+351 (Portugal)</option>
                                <option value="+44">+44 (UK)</option>
                                <option value="+1">+1 (US/Canada)</option>
                                <option value="+31">+31 (Netherlands)</option>
                                <option value="+32">+32 (Belgium)</option>
                                <option value="+41">+41 (Switzerland)</option>
                                <option value="+43">+43 (Austria)</option>
                                <option value="+48">+48 (Poland)</option>
                                <option value="+52">+52 (Mexico)</option>
                                <option value="+54">+54 (Argentina)</option>
                                <option value="+55">+55 (Brazil)</option>
                                <option value="+56">+56 (Chile)</option>
                                <option value="+57">+57 (Colombia)</option>
                            </select>
                            <span asp-validation-for="PhoneCountryCode" class="text-danger"></span>
                        </div>
                        <div class="col-md-9">
                            <label asp-for="PhoneNumber" class="form-label"></label>
                            <input asp-for="PhoneNumber" class="form-control" placeholder="e.g., 612 345 678" />
                            <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                        </div>
                    </div>

                    <hr />
                    <h5>@Localizer["Profile_Location"]</h5>

                    <div class="mb-3">
                        <label for="locationSearch" class="form-label">@Localizer["ProfileEdit_City"]</label>
                        <gmp-place-autocomplete id="locationSearch"
                                                placeholder="Start typing your city..."
                                                style="width: 100%;">
                        </gmp-place-autocomplete>
                        <div class="form-text">@Localizer["ProfileEdit_CityHelp"]</div>

                        <input type="hidden" asp-for="City" id="City" />
                        <input type="hidden" asp-for="CountryCode" id="CountryCode" />
                        <input type="hidden" asp-for="Latitude" id="Latitude" />
                        <input type="hidden" asp-for="Longitude" id="Longitude" />
                        <input type="hidden" asp-for="PlaceId" id="PlaceId" />
                    </div>

                    @if (!string.IsNullOrEmpty(Model.City))
                    {
                        <div class="mb-3">
                            <small class="text-muted">
                                @Localizer["ProfileEdit_CurrentLocation"] <strong>@Model.City, @Model.CountryCode</strong>
                                @if (Model.Latitude.HasValue && Model.Longitude.HasValue)
                                {
                                    <text> (@Model.Latitude.Value.ToString("F4"), @Model.Longitude.Value.ToString("F4"))</text>
                                }
                            </small>
                        </div>
                    }

                    <hr />

                    <div class="mb-3">
                        <label asp-for="Bio" class="form-label"></label>
                        <textarea asp-for="Bio" class="form-control" rows="4"></textarea>
                        <span asp-validation-for="Bio" class="text-danger"></span>
                        <div class="form-text">@Localizer["ProfileEdit_BioHelp"]</div>
                    </div>

                    <hr />
                    <h5>@Localizer["Profile_DateOfBirth"]</h5>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label asp-for="DateOfBirthString" class="form-label"></label>
                            <input type="date" asp-for="DateOfBirthString" class="form-control" />
                            <div class="form-text">@Localizer["ProfileEdit_DateOfBirthHelp"]</div>
                        </div>
                    </div>

                    <hr />
                    <h5>@Localizer["Profile_ContactInformation"]</h5>
                    <p class="text-muted small mb-3">
                        @Localizer["ProfileEdit_ContactInfoHelp"]
                    </p>

                    <div id="contactFieldsContainer">
                        @for (var i = 0; i < Model.EditableContactFields.Count; i++)
                        {
                            <div class="contact-field-row card mb-2" data-index="@i">
                                <div class="card-body py-2">
                                    <div class="row g-2 align-items-end">
                                        <input type="hidden" name="EditableContactFields[@i].Id" value="@Model.EditableContactFields[i].Id" />
                                        <input type="hidden" name="EditableContactFields[@i].DisplayOrder" value="@i" class="display-order" />

                                        <div class="col-md-2">
                                            <label class="form-label small">Type</label>
                                            <select name="EditableContactFields[@i].FieldType" class="form-select form-select-sm field-type-select">
                                                <option value="Email" selected="@(Model.EditableContactFields[i].FieldType == Profiles.Domain.Enums.ContactFieldType.Email)">Email</option>
                                                <option value="Phone" selected="@(Model.EditableContactFields[i].FieldType == Profiles.Domain.Enums.ContactFieldType.Phone)">Phone</option>
                                                <option value="Signal" selected="@(Model.EditableContactFields[i].FieldType == Profiles.Domain.Enums.ContactFieldType.Signal)">Signal</option>
                                                <option value="Telegram" selected="@(Model.EditableContactFields[i].FieldType == Profiles.Domain.Enums.ContactFieldType.Telegram)">Telegram</option>
                                                <option value="WhatsApp" selected="@(Model.EditableContactFields[i].FieldType == Profiles.Domain.Enums.ContactFieldType.WhatsApp)">WhatsApp</option>
                                                <option value="Other" selected="@(Model.EditableContactFields[i].FieldType == Profiles.Domain.Enums.ContactFieldType.Other)">Other</option>
                                            </select>
                                        </div>

                                        <div class="col-md-2 custom-label-col" style="display: @(Model.EditableContactFields[i].FieldType == Profiles.Domain.Enums.ContactFieldType.Other ? "block" : "none");">
                                            <label class="form-label small">Label</label>
                                            <input type="text" name="EditableContactFields[@i].CustomLabel" value="@Model.EditableContactFields[i].CustomLabel" class="form-control form-control-sm custom-label-input" placeholder="e.g., Discord" />
                                        </div>

                                        <div class="col-md-3">
                                            <label class="form-label small">Value</label>
                                            <input type="@(Model.EditableContactFields[i].FieldType == Profiles.Domain.Enums.ContactFieldType.Email ? "email" : "text")" name="EditableContactFields[@i].Value" value="@Model.EditableContactFields[i].Value" class="form-control form-control-sm contact-value-input" required placeholder="Enter contact info" />
                                            <span class="text-danger small field-validation-error" data-valmsg-for="EditableContactFields[@i].Value"></span>
                                        </div>

                                        <div class="col-md-3">
                                            <label class="form-label small">Visibility</label>
                                            <select name="EditableContactFields[@i].Visibility" class="form-select form-select-sm">
                                                <option value="AllActiveProfiles" selected="@(Model.EditableContactFields[i].Visibility == Profiles.Domain.Enums.ContactFieldVisibility.AllActiveProfiles)">All active members</option>
                                                <option value="MyTeams" selected="@(Model.EditableContactFields[i].Visibility == Profiles.Domain.Enums.ContactFieldVisibility.MyTeams)">My teams</option>
                                                <option value="LeadsAndBoard" selected="@(Model.EditableContactFields[i].Visibility == Profiles.Domain.Enums.ContactFieldVisibility.LeadsAndBoard)">Leads + Board</option>
                                                <option value="BoardOnly" selected="@(Model.EditableContactFields[i].Visibility == Profiles.Domain.Enums.ContactFieldVisibility.BoardOnly)">Board only</option>
                                            </select>
                                        </div>

                                        <div class="col-md-2 text-end">
                                            <button type="button" class="btn btn-outline-danger btn-sm remove-contact-field" title="Remove this contact field">
                                                <i class="fa-solid fa-trash me-1"></i> Remove
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <button type="button" id="addContactField" class="btn btn-outline-secondary btn-sm mb-3">
                        <i class="fa-solid fa-plus me-1"></i> @Localizer["ProfileEdit_AddContactField"]
                    </button>

                    <hr />
                    <h5>@Localizer["Profile_BurnerCV"]</h5>
                    <p class="text-muted small mb-3">
                        @Localizer["ProfileEdit_BurnerCVHelp"]
                    </p>

                    <div id="volunteerHistoryContainer">
                        @for (var i = 0; i < Model.EditableVolunteerHistory.Count; i++)
                        {
                            <div class="volunteer-history-row card mb-2" data-index="@i">
                                <div class="card-body py-2">
                                    <div class="row g-2 align-items-start">
                                        <input type="hidden" name="EditableVolunteerHistory[@i].Id" value="@Model.EditableVolunteerHistory[i].Id" />

                                        <div class="col-md-2">
                                            <label class="form-label small">Date</label>
                                            <input type="date" name="EditableVolunteerHistory[@i].DateString" value="@Model.EditableVolunteerHistory[i].DateString" class="form-control form-control-sm" required />
                                        </div>

                                        <div class="col-md-4">
                                            <label class="form-label small">Event Name</label>
                                            <input type="text" name="EditableVolunteerHistory[@i].EventName" value="@Model.EditableVolunteerHistory[i].EventName" class="form-control form-control-sm" required placeholder="e.g., Burning Man 2024, Gate Lead" maxlength="256" />
                                        </div>

                                        <div class="col-md-4">
                                            <label class="form-label small">Description</label>
                                            <input type="text" name="EditableVolunteerHistory[@i].Description" value="@Model.EditableVolunteerHistory[i].Description" class="form-control form-control-sm" placeholder="Optional details" maxlength="2000" />
                                        </div>

                                        <div class="col-md-2 text-end" style="padding-top: 1.5rem;">
                                            <button type="button" class="btn btn-outline-danger btn-sm remove-volunteer-history" title="Remove this entry">
                                                <i class="fa-solid fa-trash me-1"></i> Remove
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <button type="button" id="addVolunteerHistory" class="btn btn-outline-secondary btn-sm mb-3">
                        <i class="fa-solid fa-plus me-1"></i> @Localizer["ProfileEdit_AddEntry"]
                    </button>

                    <hr />

                    <div class="mb-3">
                        <a asp-action="PreferredEmail" class="btn btn-outline-secondary">
                            <i class="fa-solid fa-envelope me-1"></i>
                            @Localizer["ProfileEdit_ManagePreferredEmail"]
                        </a>
                        <div class="form-text">@Localizer["ProfileEdit_PreferredEmailHelp"]</div>
                    </div>

                    <hr />

                    <div class="d-flex justify-content-between">
                        <a asp-action="Index" class="btn btn-outline-secondary">@Localizer["Common_Cancel"]</a>
                        <button type="submit" class="btn btn-primary">@Localizer["Common_Save"]</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    @if (!string.IsNullOrEmpty(ViewData["GoogleMapsApiKey"]?.ToString()))
    {
        <script>
            (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
                key: "@ViewData["GoogleMapsApiKey"]",
                v: "weekly"
            });
        </script>
        <script>
            async function initPlacesAutocomplete() {
                try {
                    // Load the places library
                    await google.maps.importLibrary("places");

                    const autocomplete = document.getElementById('locationSearch');
                    if (!autocomplete) {
                        console.error('Autocomplete element not found');
                        return;
                    }

                    console.log('Autocomplete element found:', autocomplete);
                    console.log('Autocomplete tagName:', autocomplete.tagName);

                    // Listen for place selection - event is 'gmp-select' with { placePrediction }
                    autocomplete.addEventListener('gmp-select', async ({ placePrediction }) => {
                        console.log('gmp-select event, placePrediction:', placePrediction);

                        if (!placePrediction) {
                            console.error('No placePrediction');
                            return;
                        }

                        // Convert prediction to Place and fetch details
                        const place = placePrediction.toPlace();
                        await place.fetchFields({
                            fields: ['location', 'addressComponents', 'id', 'displayName']
                        });

                        console.log('Place after fetchFields:', place);

                        // Extract city and country
                        let city = '';
                        let countryCode = '';

                        if (place.addressComponents) {
                            for (const component of place.addressComponents) {
                                console.log('Component:', component.types, component.longText, component.shortText);
                                if (component.types.includes('locality')) {
                                    city = component.longText;
                                } else if (component.types.includes('administrative_area_level_1') && !city) {
                                    city = component.longText;
                                }
                                if (component.types.includes('country')) {
                                    countryCode = component.shortText;
                                }
                            }
                        }

                        // Populate hidden fields
                        document.getElementById('City').value = city;
                        document.getElementById('CountryCode').value = countryCode;
                        document.getElementById('Latitude').value = place.location?.lat() || '';
                        document.getElementById('Longitude').value = place.location?.lng() || '';
                        document.getElementById('PlaceId').value = place.id || '';

                        console.log('Location set:', city, countryCode, place.location?.lat(), place.location?.lng());
                    });

                    console.log('Places Autocomplete (New API) initialized');
                } catch (error) {
                    console.error('Error initializing Places Autocomplete:', error);
                }
            }

            initPlacesAutocomplete();
        </script>
        <style>
            gmp-place-autocomplete {
                display: block;
                width: 100%;
            }
            gmp-place-autocomplete input {
                width: 100%;
                padding: 0.375rem 0.75rem;
                font-size: 1rem;
                border: 1px solid #ced4da;
                border-radius: 0.375rem;
                line-height: 1.5;
            }
        </style>
    }
    else
    {
        <script>
            console.warn("Google Maps API key not configured. Location autocomplete disabled.");
        </script>
    }

    <script>
        (function() {
            const container = document.getElementById('contactFieldsContainer');
            const addButton = document.getElementById('addContactField');

            function getNextIndex() {
                const rows = container.querySelectorAll('.contact-field-row');
                if (rows.length === 0) return 0;
                const indices = Array.from(rows).map(r => parseInt(r.dataset.index) || 0);
                return Math.max(...indices) + 1;
            }

            function createContactFieldRow(index) {
                const html = `
                    <div class="contact-field-row card mb-2" data-index="${index}">
                        <div class="card-body py-2">
                            <div class="row g-2 align-items-end">
                                <input type="hidden" name="EditableContactFields[${index}].Id" value="" />
                                <input type="hidden" name="EditableContactFields[${index}].DisplayOrder" value="${index}" class="display-order" />

                                <div class="col-md-2">
                                    <label class="form-label small">Type</label>
                                    <select name="EditableContactFields[${index}].FieldType" class="form-select form-select-sm field-type-select">
                                        <option value="Email">Email</option>
                                        <option value="Phone">Phone</option>
                                        <option value="Signal">Signal</option>
                                        <option value="Telegram">Telegram</option>
                                        <option value="WhatsApp">WhatsApp</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>

                                <div class="col-md-2 custom-label-col" style="display: none;">
                                    <label class="form-label small">Label</label>
                                    <input type="text" name="EditableContactFields[${index}].CustomLabel" class="form-control form-control-sm custom-label-input" placeholder="e.g., Discord" />
                                </div>

                                <div class="col-md-3">
                                    <label class="form-label small">Value</label>
                                    <input type="email" name="EditableContactFields[${index}].Value" class="form-control form-control-sm contact-value-input" placeholder="Enter contact info" />
                                    <span class="text-danger small field-validation-error" data-valmsg-for="EditableContactFields[${index}].Value"></span>
                                </div>

                                <div class="col-md-3">
                                    <label class="form-label small">Visibility</label>
                                    <select name="EditableContactFields[${index}].Visibility" class="form-select form-select-sm">
                                        <option value="AllActiveProfiles" selected>All active members</option>
                                        <option value="MyTeams">My teams</option>
                                        <option value="LeadsAndBoard">Leads + Board</option>
                                        <option value="BoardOnly">Board only</option>
                                    </select>
                                </div>

                                <div class="col-md-2 text-end">
                                    <button type="button" class="btn btn-outline-danger btn-sm remove-contact-field" title="Remove this contact field">
                                        <i class="fa-solid fa-trash me-1"></i> Remove
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                const template = document.createElement('template');
                template.innerHTML = html.trim();
                return template.content.firstChild;
            }

            function validateEmailField(input, typeSelect) {
                const errorSpan = input.parentElement.querySelector('.field-validation-error');
                if (!errorSpan) return true;

                if (typeSelect.value === 'Email' && input.value.trim() !== '') {
                    // Basic email pattern check
                    const emailPattern = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/;
                    if (!emailPattern.test(input.value.trim())) {
                        errorSpan.textContent = 'Please enter a valid email address.';
                        input.classList.add('is-invalid');
                        return false;
                    }
                }
                errorSpan.textContent = '';
                input.classList.remove('is-invalid');
                return true;
            }

            function setupRow(row) {
                const typeSelect = row.querySelector('.field-type-select');
                const customLabelCol = row.querySelector('.custom-label-col');
                const valueInput = row.querySelector('.contact-value-input');
                const removeBtn = row.querySelector('.remove-contact-field');

                typeSelect.addEventListener('change', function() {
                    customLabelCol.style.display = this.value === 'Other' ? 'block' : 'none';
                    if (valueInput) {
                        valueInput.type = this.value === 'Email' ? 'email' : 'text';
                        validateEmailField(valueInput, typeSelect);
                    }
                });

                if (valueInput) {
                    valueInput.addEventListener('blur', function() {
                        validateEmailField(valueInput, typeSelect);
                    });
                }

                removeBtn.addEventListener('click', function() {
                    row.remove();
                    reindexRows();
                });
            }

            function reindexRows() {
                const rows = container.querySelectorAll('.contact-field-row');
                rows.forEach((row, idx) => {
                    row.dataset.index = idx;
                    row.querySelectorAll('[name]').forEach(input => {
                        input.name = input.name.replace(/\[\d+\]/, `[${idx}]`);
                    });
                    const displayOrder = row.querySelector('.display-order');
                    if (displayOrder) displayOrder.value = idx;
                });
            }

            // Setup existing rows
            container.querySelectorAll('.contact-field-row').forEach(setupRow);

            // Add new row
            addButton.addEventListener('click', function() {
                const index = getNextIndex();
                const row = createContactFieldRow(index);
                container.appendChild(row);
                setupRow(row);
                row.querySelector('.contact-value-input').focus();
            });

            // Validate all email fields on form submit
            const form = container.closest('form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    let valid = true;
                    container.querySelectorAll('.contact-field-row').forEach(function(row) {
                        const typeSelect = row.querySelector('.field-type-select');
                        const valueInput = row.querySelector('.contact-value-input');
                        if (typeSelect && valueInput) {
                            if (!validateEmailField(valueInput, typeSelect)) {
                                valid = false;
                            }
                        }
                    });
                    if (!valid) {
                        e.preventDefault();
                    }
                });
            }
        })();

        // Volunteer History Management
        (function() {
            const container = document.getElementById('volunteerHistoryContainer');
            const addButton = document.getElementById('addVolunteerHistory');

            function getNextIndex() {
                const rows = container.querySelectorAll('.volunteer-history-row');
                if (rows.length === 0) return 0;
                const indices = Array.from(rows).map(r => parseInt(r.dataset.index) || 0);
                return Math.max(...indices) + 1;
            }

            function createVolunteerHistoryRow(index) {
                const html = `
                    <div class="volunteer-history-row card mb-2" data-index="${index}">
                        <div class="card-body py-2">
                            <div class="row g-2 align-items-start">
                                <input type="hidden" name="EditableVolunteerHistory[${index}].Id" value="" />

                                <div class="col-md-2">
                                    <label class="form-label small">Date</label>
                                    <input type="date" name="EditableVolunteerHistory[${index}].DateString" class="form-control form-control-sm" required />
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label small">Event Name</label>
                                    <input type="text" name="EditableVolunteerHistory[${index}].EventName" class="form-control form-control-sm" required placeholder="e.g., Burning Man 2024, Gate Lead" maxlength="256" />
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label small">Description</label>
                                    <input type="text" name="EditableVolunteerHistory[${index}].Description" class="form-control form-control-sm" placeholder="Optional details" maxlength="2000" />
                                </div>

                                <div class="col-md-2 text-end" style="padding-top: 1.5rem;">
                                    <button type="button" class="btn btn-outline-danger btn-sm remove-volunteer-history" title="Remove this entry">
                                        <i class="fa-solid fa-trash me-1"></i> Remove
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                const template = document.createElement('template');
                template.innerHTML = html.trim();
                return template.content.firstChild;
            }

            function setupHistoryRow(row) {
                const removeBtn = row.querySelector('.remove-volunteer-history');

                removeBtn.addEventListener('click', function() {
                    row.remove();
                    reindexHistoryRows();
                });
            }

            function reindexHistoryRows() {
                const rows = container.querySelectorAll('.volunteer-history-row');
                rows.forEach((row, idx) => {
                    row.dataset.index = idx;
                    row.querySelectorAll('[name]').forEach(input => {
                        input.name = input.name.replace(/\[\d+\]/, `[${idx}]`);
                    });
                });
            }

            // Setup existing rows
            container.querySelectorAll('.volunteer-history-row').forEach(setupHistoryRow);

            // Add new row
            addButton.addEventListener('click', function() {
                const index = getNextIndex();
                const row = createVolunteerHistoryRow(index);
                container.appendChild(row);
                setupHistoryRow(row);
                row.querySelector('input[type="date"]').focus();
            });
        })();
    </script>
}
